<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç³»ç»Ÿæ›´æ–°å¹³å°</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
            padding: 20px;
            transition: background 0.5s ease;
        }

        .main-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 600px;
            overflow: hidden;
        }

        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .tab-nav {
            display: flex;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-button.active {
            color: #007bff;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #007bff;
        }

        .tab-button:not(.active):hover {
            background-color: #e9ecef;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-header {
            text-align: center;
            margin-bottom: 1.8rem;
        }

        .login-header h1 {
            color: #333;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .login-header p {
            color: #666;
            font-size: 0.95rem;
        }

        #networkStatus {
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            font-size: 0.9rem;
            display: none;
            animation: fadeIn 0.5s;
            margin-bottom: 15px;
        }

        .network-online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .network-offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #globalMessage {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 1.2rem;
            display: none;
            animation: fadeIn 0.5s;
        }

        .message-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .error-message {
            color: #e53e3e;
            font-size: 0.85rem;
            margin-top: 0.4rem;
            display: none;
            line-height: 1.4;
        }

        .login-button {
            width: 100%;
            padding: 12px;
            background-color: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin-bottom: 1.2rem;
        }

        .login-button:hover:not(:disabled) {
            background-color: #5a67d8;
            transform: translateY(-2px);
        }

        .login-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .login-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            opacity: 0.7;
        }

        .secondary-links {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
        }

        .secondary-links a {
            color: #667eea;
            text-decoration: none;
            transition: color 0.3s;
        }

        .secondary-links a:hover {
            color: #5a67d8;
            text-decoration: underline;
        }

        /* æ›´æ–°é¡µé¢æ ·å¼ */
        .loading-container,
        .result-container {
            padding: 20px 0;
            text-align: center;
        }

        .loading-title,
        .result-title {
            font-size: 24px;
            color: #333;
            margin-bottom: 20px;
            font-weight: 600;
        }

        .loading-desc,
        .result-desc {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .large-spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto 30px;
            border: 4px solid rgba(0, 123, 255, 0.3);
            border-radius: 50%;
            border-top-color: #007bff;
            animation: spin 1s linear infinite;
        }

        .result-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .success-icon {
            color: #28a745;
        }

        .info-icon {
            color: #17a2b8;
        }

        .version-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: left;
        }

        .version-info p {
            margin: 8px 0;
            color: #495057;
        }

        .highlight {
            color: #007bff;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0069d9;
        }

        .btn-outline {
            background-color: transparent;
            color: #007bff;
            border: 1px solid #007bff;
        }

        .btn-outline:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        /* è®°ä½æˆ‘é€‰é¡¹æ ·å¼ */
        .remember-me {
            display: flex;
            align-items: center;
            margin-bottom: 1.2rem;
        }

        .remember-me input {
            margin-right: 8px;
        }


        /* è¿›åº¦é®ç½©å±‚æ ·å¼ */
        .progress-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .progress-modal {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }

        .progress-modal h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 22px;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-bar {
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
        }

        .progress-status {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
        }

        .progress-details {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #888;
            margin-bottom: 20px;
        }

        .install-note {
            font-size: 14px;
            color: #6c757d;
            margin-top: 15px;
            font-style: italic;
        }

        .hidden {
            display: none;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @media (max-width: 480px) {
            .main-container {
                margin: 0 15px;
            }

            .tab-button {
                padding: 12px;
                font-size: 14px;
            }

            .tab-content {
                padding: 20px;
            }
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
        <div class="tab-nav">
            <button class="tab-button active" data-tab="login">ç™»å½•</button>
            <button class="tab-button" data-tab="update">æ›´æ–°</button>
        </div>

        <!-- ç™»å½•é¡µé¢ -->
        <div id="loginTab" class="tab-content active">
            <div id="networkStatus"></div>

            <div class="login-header">
                <h1>æ¬¢è¿å›æ¥</h1>
                <p>è¯·è¾“å…¥æ‚¨çš„è´¦å·ä¿¡æ¯ç™»å½•ç³»ç»Ÿ</p>
            </div>

            <div id="globalMessage"></div>

            <form id="loginForm">
                <div class="input-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" name="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                    <div id="usernameError" class="error-message">è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·å</div>
                </div>

                <div class="input-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" name="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                    <div id="passwordError" class="error-message">å¯†ç ä¸èƒ½ä¸ºç©º</div>
                </div>
                <!-- æ·»åŠ "è®°ä½æˆ‘"é€‰é¡¹ -->
                <div class="remember-me">
                    <input type="checkbox" id="rememberMe" name="rememberMe">
                    <label for="rememberMe">è®°ä½æˆ‘</label>
                </div>
                <button type="submit" class="login-button" id="loginButton">
                    <span id="buttonText">ç™»å½•</span>
                </button>

                <div class="secondary-links">
                    <a href="#" id="forgotPassword">å¿˜è®°å¯†ç ?</a>
                    <a href="#" id="register">æ³¨å†Œæ–°è´¦å·</a>
                </div>
            </form>
        </div>

        <!-- æ›´æ–°é¡µé¢ -->
        <div id="updateTab" class="tab-content">
            <!-- Loading éƒ¨åˆ† -->
            <div id="loadingSection" class="loading-container">
                <div class="large-spinner"></div>
                <h2 class="loading-title">æ­£åœ¨æ£€æŸ¥æ›´æ–°</h2>
                <p class="loading-desc">æ­£åœ¨ä¸åº”ç”¨æœåŠ¡å™¨é€šä¿¡ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬å¯ç”¨...</p>
            </div>

            <!-- ç»“æœéƒ¨åˆ† - æœ‰æ–°ç‰ˆæœ¬ -->
            <div id="updateAvailableSection" class="result-container hidden">
                <div class="result-icon">ğŸ”„</div>
                <h2 class="result-title">å‘ç°æ–°ç‰ˆæœ¬ï¼</h2>
                <p class="result-desc">å½“å‰åº”ç”¨æœ‰æ›´æ–°å¯ç”¨ï¼Œè¯·æ›´æ–°ä»¥è·å¾—æœ€æ–°åŠŸèƒ½å’Œä½¿ç”¨ä½“éªŒã€‚</p>

                <div class="version-info">
                    <p><strong>ç‰ˆæœ¬ä¿¡æ¯</strong></p>
                    <p>å½“å‰ç‰ˆæœ¬: <span id="currentVersion" class="highlight">-</span></p>
                    <p>æœ€æ–°ç‰ˆæœ¬: <span id="latestVersion" class="highlight">-</span></p>
                    <p>æ›´æ–°å†…å®¹: <span id="releaseNotes">-</span></p>
                </div>

                <div class="button-group">
                    <button id="updateNowBtn" class="btn-primary">ç«‹å³æ›´æ–°</button>
                    <button id="manualUpdateBtn" class="btn-outline">æ‰‹åŠ¨æ›´æ–°</button>
                </div>
            </div>

            <!-- ç»“æœéƒ¨åˆ† - å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ -->
            <div id="latestVersionSection" class="result-container hidden">
                <div class="result-icon success-icon">âœ…</div>
                <h2 class="result-title">å·²æ˜¯æœ€æ–°ç‰ˆæœ¬</h2>
                <p class="result-desc">ä½ çš„åº”ç”¨å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°ã€‚</p>

                <div class="version-info">
                    <p><strong>ç‰ˆæœ¬ä¿¡æ¯</strong></p>
                    <p>å½“å‰ç‰ˆæœ¬: <span id="currentVersionLatest" class="highlight">-</span></p>
                    <p>æ£€æŸ¥æ—¶é—´: <span id="checkTime">-</span></p>
                </div>

                <button id="continueBtn" class="btn-success">ç»§ç»­ä½¿ç”¨</button>
            </div>
        </div>
    </div>

    <!-- ä¸‹è½½è¿›åº¦é®ç½©å±‚ -->
    <div id="progressOverlay" class="progress-overlay hidden">
        <div class="progress-modal">
            <h3>æ›´æ–°ä¸‹è½½ä¸­</h3>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span id="progressPercentage">0%</span>
                </div>
            </div>
            <div class="progress-status">
                <span id="progressStatus">å‡†å¤‡ä¸‹è½½...</span>
            </div>
            <div class="progress-details">
                <span id="downloadSpeed">é€Ÿåº¦: 0 KB/s</span>
                <span id="downloadSize">å·²ä¸‹è½½: 0 MB / 0 MB</span>
            </div>
            <button id="cancelDownloadBtn" class="btn-outline">å–æ¶ˆä¸‹è½½</button>
        </div>
    </div>

    <!-- å®‰è£…è¿›åº¦é®ç½©å±‚ -->
    <div id="installOverlay" class="progress-overlay hidden">
        <div class="progress-modal">
            <div class="result-icon info-icon">ğŸ“¦</div>
            <h3>å®‰è£…æ›´æ–°</h3>
            <div class="progress-status">
                <span id="installStatus">å‡†å¤‡å®‰è£…...</span>
            </div>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="installProgressFill"></div>
                </div>
            </div>
            <p class="install-note">å®‰è£…å®Œæˆååº”ç”¨å°†è‡ªåŠ¨é‡å¯</p>
        </div>
    </div>
    <script type="text/javascript" src="../version.js"></script>
    <script type="text/javascript" src="../js/JSA.js"></script>
    <script type="text/javascript" src="../js/util.js"></script>
    <script type="text/javascript" src="../js/wpsApp.js"></script>
    <script>
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥æ›´æ–°
        document.addEventListener('DOMContentLoaded', function () {
            const savedCredentials = getSavedCredentials();
            if (savedCredentials) {
                document.getElementById('username').value = savedCredentials.username;
                document.getElementById('password').value = savedCredentials.password;
                document.getElementById('rememberMe').checked = true;
            }
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            const accessToken = localStorage.getItem('accessToken');

            if (accessToken) {
                // ç”¨æˆ·å·²ç™»å½•ï¼Œåˆ‡æ¢åˆ°æ›´æ–°æ ‡ç­¾é¡µå¹¶æ£€æŸ¥æ›´æ–°
                 // é‡ç½®æ›´æ–°é¡µé¢çŠ¶æ€
            
                switchToUpdateTab();
                simulateVersionCheck();
            } else {
                // ç”¨æˆ·æœªç™»å½•ï¼Œæ˜¾ç¤ºæç¤ºä¿¡æ¯
                showMessage(globalMessage, 'è¯·å…ˆç™»å½•ä»¥æ£€æŸ¥æ›´æ–°', 'message-info');
            }
        });

        // è·å–ä¿å­˜çš„å‡­è¯
        function getSavedCredentials() {
            const savedData = localStorage.getItem('systemUpdateCredentials');
            if (!savedData) return null;

            try {
                return JSON.parse(savedData);
            } catch (e) {
                console.error('è§£æä¿å­˜çš„å‡­è¯å¤±è´¥:', e);
                return null;
            }
        }

        // ä¿å­˜å‡­è¯åˆ°æœ¬åœ°å­˜å‚¨
        function saveCredentials(username, password) {
            const credentials = {
                username: username,
                password: password,
                timestamp: new Date().getTime()
            };

            localStorage.setItem('systemUpdateCredentials', JSON.stringify(credentials));
        }

        // æ¸…é™¤ä¿å­˜çš„å‡­è¯
        function clearCredentials() {
            localStorage.removeItem('systemUpdateCredentials');
        }

        // ç™»å½•è¡¨å•æäº¤å¤„ç†
        document.getElementById('loginForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            // æ ¹æ®ç”¨æˆ·é€‰æ‹©ä¿å­˜æˆ–æ¸…é™¤å‡­è¯
            if (rememberMe) {
                saveCredentials(username, password);
            } else {
                clearCredentials();
            }
        });
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
 // é‡ç½®æ›´æ–°é¡µé¢çŠ¶æ€
                resetUpdatePage();
                simulateVersionCheck();
                // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(`${tabId}Tab`).classList.add('active');
            });
        });

        // åˆ‡æ¢åˆ°æ›´æ–°æ ‡ç­¾é¡µ
        function switchToUpdateTab() {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            tabButtons[1].classList.add('active');
            tabContents[1].classList.add('active');
        }
        // é‡ç½®æ›´æ–°é¡µé¢çŠ¶æ€
        function resetUpdatePage() {
            loadingSection.classList.remove('hidden');
            updateAvailableSection.classList.add('hidden');
            latestVersionSection.classList.add('hidden');
        }
        // ç™»å½•éƒ¨åˆ†ä»£ç 
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const usernameError = document.getElementById('usernameError');
        const passwordError = document.getElementById('passwordError');
        const loginButton = document.getElementById('loginButton');
        const buttonText = document.getElementById('buttonText');
        const networkStatus = document.getElementById('networkStatus');
        const globalMessage = document.getElementById('globalMessage');

        // APIç«¯ç‚¹é…ç½®
        const API_BASE = "http://www.chuxintool.xyz:3001";
        const LOGIN_ENDPOINT = `${API_BASE}/auth/login`;

        // æ˜¾ç¤ºæ¶ˆæ¯å‡½æ•°
        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = '';
            element.classList.add(type);
            element.style.display = 'block';

            if (element !== networkStatus) {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }

        // 1. é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç½‘ç»œçŠ¶æ€
        window.addEventListener('load', () => {
            checkNetworkStatus();
        });

        // 2. ç›‘å¬åœ¨çº¿/ç¦»çº¿äº‹ä»¶
        window.addEventListener('online', () => {
            showMessage(networkStatus, 'ç½‘ç»œè¿æ¥å·²æ¢å¤ï¼æ‚¨ç°åœ¨å¯ä»¥æ­£å¸¸ç™»å½•äº†ã€‚', 'network-online');
        });

        window.addEventListener('offline', () => {
            showMessage(networkStatus, 'ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè®¾ç½®ã€‚', 'network-offline');
            loginButton.disabled = true;
            buttonText.textContent = 'ç­‰å¾…ç½‘ç»œè¿æ¥...';
        });



        function checkNetworkStatus() {
            if (navigator.onLine) {
                loginButton.disabled = false;
                buttonText.textContent = 'ç™»å½•';
            } else {
                showMessage(networkStatus, 'ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼è¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè®¾ç½®ã€‚', 'network-offline');
                loginButton.disabled = true;
                buttonText.textContent = 'ç­‰å¾…ç½‘ç»œè¿æ¥...';
            }
        }

        // 4. è¡¨å•æäº¤å¤„ç†
        loginForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            let isValid = true;

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            // é‡ç½®é”™è¯¯ä¿¡æ¯
            usernameError.style.display = 'none';
            passwordError.style.display = 'none';
            globalMessage.style.display = 'none';

            // ç”¨æˆ·åéªŒè¯
            if (username === '') {
                usernameError.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·å';
                usernameError.style.display = 'block';
                isValid = false;
            }

            // å¯†ç éªŒè¯
            if (password === '') {
                passwordError.textContent = 'å¯†ç ä¸èƒ½ä¸ºç©º';
                passwordError.style.display = 'block';
                isValid = false;
            }

            if (!isValid) {
                return;
            }

            // æ£€æŸ¥ç½‘ç»œçŠ¶æ€åå†æäº¤
            if (!navigator.onLine) {
                showMessage(globalMessage, 'ç½‘ç»œè¿æ¥ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚', 'message-error');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            loginButton.disabled = true;
            buttonText.innerHTML = '<div class="spinner"></div> ç™»å½•ä¸­...';

            try {
                // å‘é€ç™»å½•è¯·æ±‚åˆ°åç«¯API
                const response = await fetch(LOGIN_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // ç™»å½•æˆåŠŸå¤„ç†
                    showMessage(globalMessage, 'ç™»å½•æˆåŠŸï¼æ­£åœ¨åˆ‡æ¢åˆ°æ›´æ–°é¡µé¢...', 'message-success');

                    // å­˜å‚¨è®¤è¯ä¿¡æ¯
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('refreshToken', data.refreshToken);
                    localStorage.setItem('currentUser', JSON.stringify(data.user));

                    // åˆ‡æ¢åˆ°æ›´æ–°æ ‡ç­¾é¡µ
                    setTimeout(() => {
                        tabButtons[0].classList.remove('active');
                        tabButtons[1].classList.add('active');
                        tabContents[0].classList.remove('active');
                        tabContents[1].classList.add('active');

                        // å¼€å§‹æ£€æŸ¥æ›´æ–°
                        simulateVersionCheck();
                    }, 1500);
                } else {
                    // ç™»å½•å¤±è´¥å¤„ç†
                    loginButton.disabled = false;
                    buttonText.textContent = 'ç™»å½•';

                    // æ˜¾ç¤ºå…·ä½“çš„é”™è¯¯ä¿¡æ¯
                    let errorMessage = data.error || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
                    showMessage(globalMessage, errorMessage, 'message-error');
                }
            } catch (error) {
                // ç½‘ç»œé”™è¯¯å¤„ç†
                loginButton.disabled = false;
                buttonText.textContent = 'ç™»å½•';

                let errorMessage = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥åé‡è¯•';
                if (error.name === 'AbortError') {
                    errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·é‡è¯•';
                }

                showMessage(globalMessage, errorMessage, 'message-error');
            }
        });

        // å¿˜è®°å¯†ç å’Œæ³¨å†Œé“¾æ¥ç‚¹å‡»äº‹ä»¶
        document.getElementById('forgotPassword').addEventListener('click', function (e) {
            e.preventDefault();
            showMessage(globalMessage, 'å¿˜è®°å¯†ç åŠŸèƒ½ï¼šè¯·è”ç³»ç®¡ç†å‘˜qq:897081475é‡ç½®å¯†ç ã€‚', 'message-info');
        });

        document.getElementById('register').addEventListener('click', function (e) {
            e.preventDefault();
            showMessage(globalMessage, 'æ³¨å†ŒåŠŸèƒ½ï¼šè¯·è”ç³»ç®¡ç†å‘˜qq:897081475åˆ›å»ºæ–°è´¦å·ã€‚', 'message-info');
        });

        // æ›´æ–°æ£€æŸ¥éƒ¨åˆ†ä»£ç 
        let updateInfo = {};
        let xhr = null;
        let downloadStartTime;
        let lastLoaded = 0;
        let progressUpdateInterval;

        // é¡µé¢å…ƒç´ 
        const loadingSection = document.getElementById('loadingSection');
        const updateAvailableSection = document.getElementById('updateAvailableSection');
        const latestVersionSection = document.getElementById('latestVersionSection');
        const progressOverlay = document.getElementById('progressOverlay');
        const installOverlay = document.getElementById('installOverlay');

        // æ¨¡æ‹Ÿç‰ˆæœ¬æ£€æŸ¥å‡½æ•°
        async function simulateVersionCheck() {
            // åœ¨å‘èµ·è¯·æ±‚å‰ï¼Œå…ˆæ£€æŸ¥ç½‘ç»œçŠ¶æ€
            if (!navigator.onLine) {
                showNetworkError("ç½‘ç»œè¿æ¥å·²æ–­å¼€ï¼Œè¯·æ£€æŸ¥æ‚¨çš„ç½‘ç»œè®¾ç½®åå†è¯•ã€‚");
                loadingSection.classList.add('hidden');
                return;
            }

            try {
                console.log('æ­£åœ¨æ£€æŸ¥æ›´æ–°...');
                const url = `${API_BASE}/check-update?currentVersion=${VERSION}`;

                // è·å–å­˜å‚¨çš„è®¿é—®ä»¤ç‰Œ
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) {
                    showNetworkError("æœªæ‰¾åˆ°è®¿é—®ä»¤ç‰Œï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿ");
                    return;
                }

                // å»ºè®®æ·»åŠ è¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶

                const response = await fetch(url, {
                    signal: controller.signal,
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                clearTimeout(timeoutId); // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨

                // æ£€æŸ¥HTTPçŠ¶æ€ç 
                if (!response.ok) {
                    // å¯ä»¥æ ¹æ®ä¸åŒçš„çŠ¶æ€ç ç»™å‡ºæ›´ç²¾ç»†çš„æç¤º
                    if (response.status === 401) {
                        // ä»¤ç‰Œè¿‡æœŸæˆ–æ— æ•ˆ
                        showNetworkError("èº«ä»½éªŒè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•");
                        return;
                    }

                    const errorMessage = `æœåŠ¡å™¨é”™è¯¯ (${response.status})`;
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                updateInfo = data
                console.log(updateInfo)
                if (data.updateAvailable) {
                    console.log(`å‘ç°æ–°ç‰ˆæœ¬: ${data.latestVersion}`);

                    showUpdateAvailable({
                        currentVersion: `${VERSION}`,
                        latestVersion: data.latestVersion,
                        releaseNotes: data.releaseNotes,
                        downloadUrl: data.downloadUrl
                    });
                } else {
                    console.log('å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬');
                    showLatestVersion({
                        currentVersion: `${VERSION}`,
                        checkTime: new Date().toLocaleString('zh-CN')
                    });
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ›´æ–°å¤±è´¥: ', error);
                // å…³é”®æ­¥éª¤ï¼šæ— è®ºä½•ç§é”™è¯¯ï¼Œå…ˆéšè—æ›´æ–°æ£€æŸ¥ç•Œé¢
                loadingSection.classList.add('hidden'); // æ·»åŠ è¿™è¡Œ
                let userFacingMessage = 'æ£€æŸ¥æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚'; // é»˜è®¤æç¤º

                // æ ¹æ®é”™è¯¯ç±»å‹ç»†åŒ–æç¤ºä¿¡æ¯
                if (error.name === 'AbortError') {
                    userFacingMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åå†è¯•ã€‚';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    userFacingMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæ˜¯å¦ç•…é€šï¼Œæˆ–æœåŠ¡å™¨æ˜¯å¦å¯è®¿é—®ã€‚';
                } else if (error.message.includes('æœåŠ¡å™¨é”™è¯¯')) {
                    userFacingMessage = `æœåŠ¡å™¨æš‚æ—¶å‡ºç°é—®é¢˜ï¼ˆ${error.message}ï¼‰ï¼Œè¯·ç¨åå†è¯•ã€‚`;
                }

                // è°ƒç”¨ä¸€ä¸ªæ›´å‹å¥½çš„UIæç¤ºå‡½æ•°ï¼Œå¹¶æä¾›é‡è¯•é€‰é¡¹
                showNetworkError(userFacingMessage, () => {
                    simulateVersionCheck();
                });
            }
        }

        // æ˜¾ç¤ºå‹å¥½é”™è¯¯æç¤º
        function showNetworkError(message, onRetry) {
            const errorBar = document.createElement('div');
            errorBar.style.cssText = 'background-color: #fee; border: 1px solid #fcc; padding: 10px; text-align: center;';
            errorBar.innerHTML = `
                <span>${message}</span>
                ${onRetry ? '<button style="margin-left: 10px;" id="retryButton">é‡è¯•</button>' : ''}
                <button style="margin-left: 5px;" id="closeErrorButton">å…³é—­</button>
            `;
            document.body.prepend(errorBar);
            // éšè—ä¸»å®¹å™¨
            document.querySelector('.main-container').style.display = 'none';

            if (onRetry) {
                document.getElementById('retryButton').addEventListener('click', function () {
                    document.querySelector('.main-container').style.display = 'block';

                    errorBar.remove();
                    loadingSection.classList.remove('hidden');
                    onRetry();
                });
            }

            document.getElementById('closeErrorButton').addEventListener('click', function () {
                errorBar.remove();
                // æ˜¾ç¤ºä¸»å®¹å™¨
                document.querySelector('.main-container').style.display = 'block';

                // åˆ‡æ¢åˆ°ç™»å½•æ ‡ç­¾é¡µ
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));
                tabButtons[0].classList.add('active');
                tabContents[0].classList.add('active');
            });
        }

        // æ˜¾ç¤ºæ›´æ–°å¯ç”¨ç•Œé¢
        function showUpdateAvailable(versionInfo) {
            loadingSection.classList.add('hidden');

            document.getElementById('currentVersion').textContent = versionInfo.currentVersion;
            document.getElementById('latestVersion').textContent = versionInfo.latestVersion;
            document.getElementById('releaseNotes').textContent = versionInfo.releaseNotes;

            updateAvailableSection.classList.remove('hidden');
        }

        // æ˜¾ç¤ºå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ç•Œé¢
        function showLatestVersion(versionInfo) {
            loadingSection.classList.add('hidden');

            document.getElementById('currentVersionLatest').textContent = versionInfo.currentVersion;
            document.getElementById('checkTime').textContent = versionInfo.checkTime;

            latestVersionSection.classList.remove('hidden');
        }

        // æ˜¾ç¤ºè¿›åº¦é®ç½©å±‚
        function showProgressOverlay() {
            progressOverlay.classList.remove('hidden');
            updateProgress(0, 'å‡†å¤‡ä¸‹è½½...');
            document.getElementById('downloadSpeed').textContent = 'é€Ÿåº¦: 0 KB/s';
            document.getElementById('downloadSize').textContent = 'å·²ä¸‹è½½: 0 MB / 0 MB';
        }

        // éšè—è¿›åº¦é®ç½©å±‚
        function hideProgressOverlay() {
            progressOverlay.classList.add('hidden');
            if (progressUpdateInterval) {
                clearInterval(progressUpdateInterval);
            }
        }

        // æ˜¾ç¤ºå®‰è£…é®ç½©å±‚
        function showInstallOverlay() {
            installOverlay.classList.remove('hidden');
        }

        // éšè—å®‰è£…é®ç½©å±‚
        function hideInstallOverlay() {
            installOverlay.classList.add('hidden');
        }

        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress(percent, status) {
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressStatus = document.getElementById('progressStatus');

            progressFill.style.width = percent + '%';
            progressPercentage.textContent = percent.toFixed(1) + '%';
            progressStatus.textContent = status || 'ä¸‹è½½ä¸­...';
        }

        // æ›´æ–°ä¸‹è½½è¯¦æƒ…ï¼ˆé€Ÿåº¦ã€å¤§å°ï¼‰
        function updateDownloadDetails(loaded, total) {
            const downloadSize = document.getElementById('downloadSize');
            const downloadSpeed = document.getElementById('downloadSpeed');

            const now = Date.now();
            const elapsedTime = (now - downloadStartTime) / 1000;
            const downloadedBytes = loaded - lastLoaded;
            const speed = elapsedTime > 0 ? downloadedBytes / elapsedTime : 0;

            const loadedMB = (loaded / (1024 * 1024)).toFixed(2);
            const totalMB = (total / (1024 * 1024)).toFixed(2);
            const speedKB = (speed / 1024).toFixed(1);

            downloadSize.textContent = `å·²ä¸‹è½½: ${loadedMB} MB / ${totalMB} MB`;
            downloadSpeed.textContent = `é€Ÿåº¦: ${speedKB} KB/s`;

            lastLoaded = loaded;
        }

        // æ›´æ–°å®‰è£…è¿›åº¦
        function updateInstallProgress(percent, status) {
            const installProgressFill = document.getElementById('installProgressFill');
            const installStatus = document.getElementById('installStatus');

            installProgressFill.style.width = percent + '%';
            installStatus.textContent = status || 'å®‰è£…ä¸­...';
        }

        // ç«‹å³æ›´æ–°
        async function updateNow() {
            try {
                // æ˜¾ç¤ºè¿›åº¦é®ç½©å±‚
                showProgressOverlay();

                console.log('å¼€å§‹ä¸‹è½½æ›´æ–°åŒ…...');
                const downloadUrl = `${API_BASE}${updateInfo.downloadUrl}`;

                // è·å–å­˜å‚¨çš„è®¿é—®ä»¤ç‰Œ
                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) {
                    throw new Error('æœªæ‰¾åˆ°è®¿é—®ä»¤ç‰Œï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿ');
                }

                // ä½¿ç”¨XMLHttpRequestä»¥ä¾¿è·å–ä¸‹è½½è¿›åº¦
                xhr = new XMLHttpRequest();
                xhr.open('GET', downloadUrl, true);
                xhr.responseType = 'blob';

                // æ·»åŠ Authorizationå¤´
                xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);

                // åˆå§‹åŒ–ä¸‹è½½è·Ÿè¸ª
                downloadStartTime = Date.now();
                lastLoaded = 0;

                // è®¾ç½®å®šæœŸæ›´æ–°è¿›åº¦ï¼ˆæ¯ç§’æ›´æ–°ä¸€æ¬¡é€Ÿåº¦ä¿¡æ¯ï¼‰
                progressUpdateInterval = setInterval(() => {
                    if (xhr && xhr.status === 200) {
                        updateDownloadDetails(lastLoaded, xhr.total);
                    }
                }, 1000);

                // ç›‘å¬è¿›åº¦äº‹ä»¶
                xhr.onprogress = function (event) {
                    if (event.lengthComputable) {
                        const percent = (event.loaded / event.total) * 100;
                        updateProgress(percent, 'ä¸‹è½½ä¸­...');
                        updateDownloadDetails(event.loaded, event.total);
                    }
                };

                xhr.onload = function () {
                    if (xhr.status === 200) {
                        // ä¸‹è½½å®Œæˆï¼Œæ¸…é™¤å®šæ—¶å™¨
                        if (progressUpdateInterval) {
                            clearInterval(progressUpdateInterval);
                        }

                        updateProgress(100, 'ä¸‹è½½å®Œæˆï¼Œæ­£åœ¨éªŒè¯...');

                        // å¤„ç†ä¸‹è½½çš„æ–‡ä»¶
                        processDownloadedFile(xhr.response);
                    } else {
                        hideProgressOverlay();
                        alert('ä¸‹è½½å¤±è´¥: ' + xhr.statusText);
                    }
                };

                xhr.onerror = function () {
                    hideProgressOverlay();
                    alert('ä¸‹è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
                };

                xhr.send();

            } catch (error) {
                console.log('ä¸‹è½½æ›´æ–°å¤±è´¥: ' + error.message);
                hideProgressOverlay();
                alert('ä¸‹è½½å¤±è´¥: ' + error.message);
            }
        }
        // å¤„ç†ä¸‹è½½çš„æ–‡ä»¶
        async function processDownloadedFile(blobData) {
            try {
                // éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
                const arrayBuffer = await blobData.arrayBuffer();
                const hashArrayBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
                const hashArray = Array.from(new Uint8Array(hashArrayBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                console.log(hashHex + "æœåŠ¡å™¨å“ˆå¸Œ" + updateInfo.fileHash)
                if (hashHex !== updateInfo.fileHash) {
                    updateProgress(0, 'æ–‡ä»¶éªŒè¯å¤±è´¥');
                    setTimeout(() => {
                        hideProgressOverlay();
                        alert('æ–‡ä»¶ä¸å®Œæ•´ï¼Œè¯·é‡æ–°ä¸‹è½½ï¼');
                    }, 100);
                    return;
                }
                const tmpFile = window.Application.Env.GetTempPath() + "/zoteroUpdate.tar.gz"
                if (window.Application.FileSystem.Exists(tmpFile)) {
                    window.Application.FileSystem.Remove(tmpFile)
                }
                const binaryString = await blobToBinaryString(blobData);

                await wps.FileSystem.writeAsBinaryString(tmpFile, binaryString);
                // éšè—ä¸‹è½½è¿›åº¦ï¼Œæ˜¾ç¤ºå®‰è£…è¿›åº¦
                hideProgressOverlay();
                showInstallOverlay();
                const osInfo = detectOS();
                const tutorial = getAddonPath(osInfo)
                const jsaddonsPath = getJsaddonsPath(osInfo)
                // æ¨¡æ‹Ÿå®‰è£…è¿‡ç¨‹
                await simulateInstallation(tmpFile, jsaddonsPath);

            } catch (error) {
                console.log('æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message);
                hideProgressOverlay();
                alert('æ–‡ä»¶å¤„ç†å¤±è´¥: ' + error.message);
            }
        }


        // æ¨¡æ‹Ÿå®‰è£…è¿‡ç¨‹
        async function simulateInstallation(tmpFile, jsaddonsPath) {
            // æ¨¡æ‹Ÿå®‰è£…è¿›åº¦æ›´æ–°
            updateInstallProgress(10, 'å‡†å¤‡å®‰è£…æ–‡ä»¶...');


            if (!window.Application.FileSystem.Exists(tmpFile)) {
                alert("æ–‡ä»¶ç¼ºå¤±ï¼Œè¯·é‡æ–°æ›´æ–°ï¼")
                return
            }
            updateInstallProgress(50, 'å¤‡ä»½å½“å‰ç‰ˆæœ¬...');
            await new Promise(resolve => setTimeout(resolve, 3000));
            const funZipStr = `Shell('cmd.exe /c "cd  ${jsaddonsPath} && tar -czvf zoteroBack.tar.gz -C wps-zotero_1.0.0 ."', jsHide)`
            runFun('zipFile', funZipStr)

            updateInstallProgress(30, 'è§£å‹æ›´æ–°åŒ…...');
            await new Promise(resolve => setTimeout(resolve, 100));
            const funTarStr = `Shell('cmd.exe /c " tar -xf ${tmpFile} -C ${jsaddonsPath}/wps-zotero_1.0.0 "', jsHide)`
            runFun('tarFile', funTarStr)

            updateInstallProgress(80, 'å®‰è£…æ–°æ–‡ä»¶...');
            await new Promise(resolve => setTimeout(resolve, 100));

            updateInstallProgress(100, 'å®Œæˆå®‰è£…...');
            await new Promise(resolve => setTimeout(resolve, 100));

            // å®Œæˆå®‰è£…
            document.getElementById('installStatus').textContent = 'å®‰è£…æˆåŠŸï¼';

            // 2ç§’åéšè—å®‰è£…é®ç½©å±‚
            setTimeout(() => {
                hideInstallOverlay();
                alert('æ›´æ–°å·²æˆåŠŸå®‰è£…ï¼æ’ä»¶å°†åœ¨é‡å¯åå®Œæˆæ›´æ–°ã€‚');
                window.close()
            }, 100);
        }

        // å–æ¶ˆä¸‹è½½
        function cancelDownload() {
            if (xhr) {
                xhr.abort();
            }
            hideProgressOverlay();
            alert('ä¸‹è½½å·²å–æ¶ˆ');
        }
        // æ˜¾ç¤ºæ‰‹åŠ¨æ›´æ–°è¯´æ˜
        async function showManualUpdateInstructions() {

            try {
                // æ„é€ å®Œæ•´ä¸‹è½½åœ°å€
                const downloadUrl = `${API_BASE}${updateInfo.downloadUrl}`;

                // 1. è·å–æ–‡ä»¶æ•°æ®
                const response = await fetch(downloadUrl);
                if (!response.ok) throw new Error(`ä¸‹è½½å¤±è´¥: ${response.status}`);

                // 2. ç”ŸæˆBlobå¯¹è±¡
                const fileBlob = await response.blob();

                // 3. è°ƒç”¨ä¸‹è½½æ–¹æ³•
                saveBlobToTempFile(fileBlob, "zotero-update.tar.gz"); // æ·»åŠ æ–‡ä»¶æ‰©å±•å

            } catch (error) {
                console.error("æ›´æ–°æ–‡ä»¶ä¸‹è½½å¤±è´¥:", error);
                alert("ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥");
            }
        }
        async function saveBlobToTempFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();

            // æ·»åŠ æ¸…ç†ä»£ç 
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url); // é‡Šæ”¾å†…å­˜
            }, 100);
        }
        // ç»§ç»­ä½¿ç”¨
        function continueUsing() {
            window.close()
        }

        function blobToBinaryString(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = event => {
                    resolve(event.target.result);
                };
                reader.onerror = error => {
                    reject(error);
                };
                reader.readAsBinaryString(blob);
            });
        }


        // è¾…åŠ©å‡½æ•°
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // æŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('updateNowBtn').addEventListener('click', updateNow);
        document.getElementById('manualUpdateBtn').addEventListener('click', showManualUpdateInstructions);
        document.getElementById('continueBtn').addEventListener('click', continueUsing);
        document.getElementById('cancelDownloadBtn').addEventListener('click', cancelDownload);
    </script>
</body>

</html>